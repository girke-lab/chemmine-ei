/* 
    Copyright (C) 2008 Wei Dong <wdong@princeton.edu>. All Rights Reserved.
  
    This file is part of LSHKIT.
  
    LSHKIT is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    LSHKIT is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with LSHKIT.  If not, see <http://www.gnu.org/licenses/>.
*/

#ifndef LSHKIT_MATRIX_IO
#define LSHKIT_MATRIX_IO

#include <cassert>
#include <sys/time.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <fcntl.h>

namespace lshkit{

template <class T>
void Matrix<T>::load (const std::string &path)
{
    unsigned header[3]; /* entry size, row, col */
    assert(sizeof header == 3*4);
	int fd = ::open(path.c_str(), O_RDONLY);
	assert(fd >= 0);
	if (::read(fd, header, sizeof header) != sizeof header) assert(0);
    assert(header[0] == sizeof(float));
    reset(header[2], header[1]);
	unsigned sz = sizeof(T) * dim * N;
	if (::read(fd, dims, sz) != sz) assert(0);
	::close(fd);
}

template <class T>
void Matrix<T>::dump (const std::string &path)
{
    unsigned header[3];
	int fd = ::open(path.c_str(), O_WRONLY | O_CREAT, 0644);
	assert(fd >= 0);
    header[0] = sizeof(float);
    header[1] = N;
    header[2] = dim;
    if (::write(fd, header, sizeof header) != sizeof header) assert(0);
	unsigned sz = sizeof(T) * dim * N;
	if (::write(fd, dims, sz) != sz) assert(0);
	::close(fd);
}


}

#endif

